<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Gamify your life with tasks, XP, levels, and rewards">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QOL">
    <meta name="mobile-web-app-status-bar-style" content="black">
    <title>Quest of Life</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="manifest" href="./manifest.json?v=2">
    <style>
        /* ===== Global Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent-color: #FF6B9D;
            --bg-color: #FFF8E7;
            --text-color: #2D3436;
            --text-light: #636E72;
            --border-color: #FFD93D;
            --hover-bg: #FFF4C9;
            --card-bg: #FFFFFF;
            --success-color: #6BCF7F;
            --danger-color: #FF6B6B;
            --shadow: 0 4px 12px rgba(255, 107, 157, 0.15);
            --gradient-1: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            --gradient-2: linear-gradient(135deg, #F093FB 0%, #F5576C 100%);
            --gradient-3: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);
            --gradient-4: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
            --gradient-5: linear-gradient(135deg, #FA709A 0%, #FEE140 100%);
        }

        html, body {
          overscroll-behavior-x: none; /* disable horizontal nav */
        }

        html {
            height: 100%;
            height: 100vh;
            height: -webkit-fill-available;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #FFF8E7 0%, #FFE5F1 50%, #E8F5FF 100%);
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
            min-height: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
        }

        /* ===== Container & Layout ===== */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 120px !important; /* Space for bottom navigation */
        }

        /* ===== Navigation ===== */
        nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 3px solid var(--accent-color);
            padding: 15px 0;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(255, 107, 157, 0.2);
        }

        nav ul {
            display: flex;
            list-style: none;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        nav button {
            padding: 12px 24px;
            font-size: 16px;
            background: transparent;
            color: var(--text-color);
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        nav button.active {
            background: var(--gradient-2);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        /* ===== Screen Management ===== */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ===== Typography ===== */
        h1 {
            font-size: 36px;
            margin-bottom: 20px;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 26px;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--text-color);
        }

        h3 {
            font-size: 20px;
            margin-bottom: 12px;
            font-weight: 700;
            color: var(--text-color);
        }

        /* ===== Buttons ===== */
        button, .btn {
            padding: 12px 20px;
            font-size: 16px;
            background: var(--gradient-2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        button:active, .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #A8DADC 0%, #457B9D 100%);
            box-shadow: 0 4px 15px rgba(168, 218, 220, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #6BCF7F 0%, #38F9D7 100%);
            box-shadow: 0 4px 15px rgba(107, 207, 127, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* ===== Forms ===== */
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 3px solid rgba(255, 107, 157, 0.2);
            border-radius: 12px;
            margin-bottom: 15px;
            font-family: inherit;
            background: rgba(255, 248, 231, 0.5);
            color: var(--text-color);
            transition: all 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            background: white;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.2);
            transform: translateY(-2px);
        }

        select option {
            background: var(--card-bg);
            color: var(--text-color);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        /* ===== Task Item ===== */
        .task-item {
            background: white;
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: stretch;
        }

        .task-drag-handle {
            width: 24px;
            min-width: 24px;
            margin-right: 8px;
            margin-left: -12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: var(--text-light);
            font-size: 20px;
            user-select: none;
        }

        .task-drag-handle:active {
            cursor: grabbing;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-item.dragging {
            opacity: 0.7;
        }

        .task-item.completed {
            opacity: 0.7;
            background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%);
        }

        .task-header {
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            width: 65%;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            float: right;
            margin-left: 12px;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 14px;
            color: var(--text-light);
            clear: both;
            margin-top: 25px;
        }

        .task-badge {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #FFF4C9 0%, #FFE5F1 100%);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid rgba(255, 107, 157, 0.2);
        }

        .category-badge {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            color: white;
            border: none;
        }

        .base-strip {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
            height: 30px;
            overflow: hidden;
        }
        
        /* ===== Progress Bars ===== */
        .progress-bar {
            width: 100%;
            height: 28px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 2px solid rgba(255, 107, 157, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B9D, #FFD93D, #6BCF7F);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* ===== Stats Grid ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.2);
            transition: all 0.3s;
        }

        .stat-value {
            font-size: 40px;
            font-weight: 800;
            background-clip: text;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* ===== Category Progress ===== */
        .category-progress {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 500;
        }

        /* ===== Badges Grid ===== */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .badge-item {
            background: white;
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .badge-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .badge-name {
            font-size: 14px;
            font-weight: 600;
        }

        .badge-desc {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* ===== Rewards ===== */
        .reward-item {
            background: white;
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .reward-info {
            flex: 1;
        }

        .reward-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* ===== Collapsible Section ===== */
        .collapsible {
            margin-top: 30px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: linear-gradient(135deg, rgba(255, 244, 201, 0.8), rgba(255, 229, 241, 0.8));
            border-radius: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            border: 2px solid rgba(255, 107, 157, 0.2);
            transition: all 0.3s;
        }

        .collapsible-content {
            display: none;
        }

        .collapsible-content.open {
            display: block;
        }

        /* ===== Modal ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border: 4px solid transparent;
            border-radius: 24px;
            padding: 35px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(255, 107, 157, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            color: var(--text-color);
            font-size: 24px;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* ===== Responsive ===== */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 26px;
            }

            h2 {
                font-size: 22px;
            }

            nav button {
                padding: 10px 16px;
                font-size: 14px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== Utility Classes ===== */
        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gap-10 {
            gap: 10px;
        }

        .wp-40 {
            width: 40%;
        }
        
        .ps-rl {
            position: relative;
        }

        /* ===== Add Button Aligned Right ===== */
        .add-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .add-btn-right {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-4);
            color: white;
            border: none;
            font-size: 32px;
            line-height: 1;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(67, 233, 123, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .add-btn-right:active {
            transform: scale(1.05) rotate(90deg);
        }

        /* ===== Theme Toggle Switch ===== */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-4);
            transition: 0.4s;
            border-radius: 34px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .theme-slider:before {
            position: absolute;
            content: "☀️";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .theme-slider {
            background: var(--gradient-1);
        }

        input:checked + .theme-slider:before {
            transform: translateX(21px);
            content: "🌙";
        }

        /* ===== Dark Theme Overrides ===== */
        body.dark-theme .task-item {
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(255,255,255,0.10);
            background-color: #181c24;
        }

        body.dark-theme .task-item.completed {
            opacity: 0.8;
            background: linear-gradient(135deg, #2a2d3a 0%, #3a3f5a 100%);
        }

        body.dark-theme .task-badge {
            background: linear-gradient(135deg, #3a3f5a 0%, #5a6bff 100%);
            border: 1.5px solid #5a6bff;
        }

        body.dark-theme .category-badge {
            background: linear-gradient(135deg, #3a3f5a 0%, #5a6bff 100%);
            color: #fff;
        }

        body.dark-theme .stat-card,
        body.dark-theme .badge-item,
        body.dark-theme .reward-item {
            border: 2px solid #5a6bff;
            box-shadow: 0 4px 16px rgba(90,107,255,0.15);
            background-color: #181c24;
        }

        body.dark-theme h1 {
            background: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: var(--text-color);
            background-clip: unset;
        }

        body.dark-theme nav {
            background: var(--bg-color);
            backdrop-filter: none;
            border-top: 2px solid var(--border-color);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }

        body.dark-theme nav button {
            border: 2px solid var(--border-color);
        }

        body.dark-theme nav button.active {
            background: linear-gradient(135deg, #5a6bff 0%, #ff6b9d 100%);
            box-shadow: 0 2px 8px rgba(255,107,157,0.25);
        }

        body.dark-theme button,
        body.dark-theme .btn {
            box-shadow: 0 2px 8px rgba(255,107,157,0.25);
        }

        body.dark-theme .btn-secondary {
            background: linear-gradient(135deg, #6bcf7f 0%, #5a6bff 100%);
            box-shadow: 0 2px 8px rgba(90,107,255,0.15);
        }

        body.dark-theme .btn-success {
            background: linear-gradient(135deg, #6bcf7f 0%, #43e97b 100%);
            box-shadow: 0 2px 8px rgba(67,233,123,0.15);
        }

        body.dark-theme .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff6b9d 100%);
            box-shadow: 0 2px 8px rgba(255,107,157,0.15);
        }

        body.dark-theme .modal-content {
            background: #000000 !important;
            border: 2px solid var(--border-color) !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
        }

        body.dark-theme .modal-title {
            color: #ffffff !important;
        }

        body.dark-theme label {
            color: #cccccc !important;
        }

        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #1a1a1a !important;
            color: #ffffff !important;
            border: 1px solid #333333 !important;
        }

        body.dark-theme input:focus,
        body.dark-theme select:focus,
        body.dark-theme textarea:focus {
            border-color: #666666 !important;
            background: #2a2a2a !important;
        }

        body.dark-theme .collapsible-header {
            background: var(--hover-bg);
            border: none;
        }

        body.dark-theme .add-btn-right {
            background: linear-gradient(135deg, #5a6bff 0%, #ff6b9d 100%);
            box-shadow: 0 4px 16px rgba(255,107,157,0.25);
        }

        body.dark-theme .add-btn-right:active {
            transform: scale(1.05) translateY(0);
        }

        body.dark-theme .progress-bar {
            background: var(--hover-bg);
            border: none;
        }

        body.dark-theme .progress-fill {
            background: linear-gradient(90deg, #444444, #666666);
            color: #e0e0e0;
        }

        /* ===== Toast Notifications ===== */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 16px rgba(67, 233, 123, 0.3);
            z-index: 1000;
            transform: translate(-50%, 100%);
            opacity: 0;
            transition: all 0.3s ease;
            font-weight: 500;
            max-width: 300px;
        }

        .toast.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

        .toast.hide {
            transform: translate(-50%, 100%);
            opacity: 0;
        }

        body.dark-theme .toast {
            background: linear-gradient(135deg, #6bcf7f 0%, #43e97b 100%);
            box-shadow: 0 4px 16px rgba(67, 233, 123, 0.2);
        }

        #clear-search-btn
        {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%); 
            background: transparent;
            border: none;
            color: var(--text-light); 
            font-size: 20px;
            padding: 5px 10px;
            cursor: pointer;
            box-shadow: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <ul>
            <li><button class="nav-btn active" data-screen="day-view">Today</button></li>
            <li><button class="nav-btn" data-screen="dashboard">Dashboard</button></li>
            <li><button class="nav-btn" data-screen="quests">Quests</button></li>
            <li><button class="nav-btn" data-screen="settings">Settings</button></li>
        </ul>
    </nav>

    <div class="container">
        <!-- ===== DAY VIEW SCREEN ===== -->
        <div id="day-view" class="screen active">
            <div id="tasks-container"></div>
        </div>

        <!-- ===== DASHBOARD SCREEN ===== -->
        <div id="dashboard" class="screen">
            <!-- Player Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="player-level">1</span>
                    <span class="stat-label">Level</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="player-xp">0</span>
                    <span class="stat-label">Total XP</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="player-coins">0</span>
                    <span class="stat-label">Coins</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" onclick="switchScreen('rewards')">🏆</span>
                    <span class="stat-label">Rewards</span>
                </div>
            </div>

            <!-- Level Progress -->
            <div class="category-header">
                <h3>Level Progress</h3>
                <span id="level-progress-text" style="margin-top: 18px;">0 / 100 XP</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="level-progress" style="width: 0%"></div>
            </div>

            <!-- Category Progress -->
            <h2 class="mt-20">Category Progress</h2>
            <div id="category-progress-container"></div>

            <!-- Streaks -->
            <h2 class="mt-20">Current Streaks</h2>
            <div id="streaks-container"></div>

            <!-- Badges -->
            <h2 class="mt-20">Earned Badges</h2>
            <div id="badges-container" class="badges-grid"></div>
        </div>

        <!-- ===== REWARDS SCREEN ===== -->
        <div id="rewards" class="screen">
            <div class="stat-card mb-20">
                <span class="stat-value" id="rewards-coins">0</span>
                <span class="stat-label">Available Coins</span>
            </div>

            <div id="rewards-container"></div>

            <div class="add-btn-container">
                <button class="add-btn-right" onclick="openRewardModal()">+</button>
            </div>
        </div>

        <div id="quests" class="screen">
            <h1>All Quests</h1>

            <!-- Search Bar -->
            <div class="ps-rl mb-20">
                <input type="text" id="quest-search" placeholder="🔍 Search or Add tasks..." 
                       oninput="filterQuests()" style="margin-bottom: 0;">
                <button onclick="resetQuestFilter()" id="clear-search-btn">×</button>
            </div>

            <!-- Quests List -->
            <div id="quests-container"></div>
        </div>

        <!-- ===== SETTINGS SCREEN ===== -->
        <div id="settings" class="screen">
            <!-- Categories Management -->
            <h2>Categories</h2>
            <div id="categories-list" class="mb-20"></div>
            <div class="add-btn-container">
                <button class="add-btn-right" onclick="openCategoryModal()">+</button>
            </div>

            <!-- Default Values -->
            <h2 class="mt-20">Default Task Values</h2>
            <label>Default XP per Task</label>
            <input type="number" id="default-xp" value="10" min="1">

            <label>Default Coins per Task</label>
            <input type="number" id="default-coins" value="5" min="1">

            <!-- Theme Toggle -->
            <h2 class="mt-20">Theme</h2>
            <div class="task-item" style="cursor: default;">
                <div class="flex-between">
                    <div>
                        <div class="task-title" style="font-size: 16px; margin-bottom: 5px;">Dark Theme</div>
                        <div style="font-size: 14px; color: var(--text-light);">Switch between dark AMOLED and bright joyful theme</div>
                    </div>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="theme-slider"></span>
                    </label>
                </div>
            </div>

            <button onclick="saveSettings()" class="mt-20 btn-secondary">Save Settings</button>

            <!-- Data Management -->
            <h2 class="mt-20">Data Management</h2>
            <button onclick="exportData()" class="btn-secondary">Export</button>
            <button onclick="importData()" class="btn-secondary">Import</button>
            <button onclick="resetData()" class="btn-danger">Reset All</button>
        </div>
    </div>

    <!-- ===== TASK MODAL ===== -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="task-modal-title">Add Task</h2>
                <button class="modal-close" onclick="closeTaskModal()">×</button>
            </div>

            <input type="hidden" id="task-id">

            <label>Task Title</label>
            <input type="text" id="task-title" placeholder="Enter task title">

            <label>Category</label>
            <select id="task-category"></select>

            <label>Recurrence</label>
            <select id="task-recurrence" onchange="handleRecurrenceChange()">
                <option value="once">One-time</option>
                <option value="daily">Daily</option>
                <option value="multiple">Multiple times a day</option>
            </select>

            <div id="times-per-day-container" style="display: none;">
                <label>Times per day</label>
                <input type="number" id="task-times-per-day" value="3" min="2" max="20">
            </div>

            <label>XP Reward</label>
            <input type="number" id="task-xp" value="10" min="1">

            <label>Coin Reward</label>
            <input type="number" id="task-coins" value="5" min="1">

            <div class="flex-between gap-10 mt-20">
                <button onclick="saveTask()" class="btn-success">Save Task</button>
                <button onclick="closeTaskModal()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ===== REWARD MODAL ===== -->
    <div id="reward-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Reward</h2>
                <button class="modal-close" onclick="closeRewardModal()">×</button>
            </div>

            <input type="hidden" id="reward-id">

            <label>Reward Name</label>
            <input type="text" id="reward-name" placeholder="e.g., Movie Night">

            <label>Cost (Coins)</label>
            <input type="number" id="reward-cost" value="50" min="1">

            <div class="flex-between gap-10 mt-20">
                <button onclick="saveReward()" class="btn-success">Save Reward</button>
                <button onclick="closeRewardModal()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ===== CATEGORY MODAL ===== -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Category</h2>
                <button class="modal-close" onclick="closeCategoryModal()">×</button>
            </div>

            <label>Category Name</label>
            <input type="text" id="category-name" placeholder="e.g., Health">

            <div class="flex-between gap-10 mt-20">
                <button onclick="saveCategory()" class="btn-success">Save Category</button>
                <button onclick="closeCategoryModal()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA STRUCTURE =====
        let appData = {
            player: {
                level: 1,
                xp: 0,
                coins: 0
            },
            categories: [
                { id: 'health', name: 'Health', xp: 0, level: 1 },
                { id: 'family', name: 'Family', xp: 0, level: 1 },
                { id: 'paperwork', name: 'Paperwork', xp: 0, level: 1 },
                { id: 'hobby', name: 'Hobby', xp: 0, level: 1 },
                { id: 'house', name: 'House', xp: 0, level: 1 },
                { id: 'vices', name: 'Vices', xp: 0, level: 1 },
                { id: 'career', name: 'Career', xp: 0, level: 1 }
            ],
            tasks: [],
            rewards: [],
            badges: [],
            settings: {
                defaultXp: 10,
                defaultCoins: 5,
                darkTheme: false
            }
        };

        // ===== INITIALIZATION =====
        function initApp() {
            // Load data from localStorage
            loadData();
            
            // Apply theme
            applyTheme();
            
            // Set up navigation
            setupNavigation();
            
            // Render initial screen
            renderDayView();
            
            // Check for badge achievements
            checkBadges();
            
            // Register service worker
            registerServiceWorker();
        }

        // ===== LOCAL STORAGE =====
        function saveData() {
            localStorage.setItem('qolData', JSON.stringify(appData));
        }

        function loadData() {
            const saved = localStorage.getItem('qolData');
            if (saved) {
                const loaded = JSON.parse(saved);
                // Merge loaded data with defaults to handle new properties
                appData = { ...appData, ...loaded };
                
                // Ensure all categories have required properties
                appData.categories = appData.categories.map(cat => ({
                    xp: 0,
                    level: 1,
                    ...cat
                }));
            }
        }

        // ===== NAVIGATION =====
        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const screenId = btn.dataset.screen;
                    switchScreen(screenId);
                });
            });
        }

        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected screen
            document.getElementById(screenId).classList.add('active');
            const navItem = document.querySelector(`[data-screen="${screenId}"]`);
            if (navItem) navItem.classList.add('active');
            
            // Render screen content
            switch(screenId) {
                case 'day-view':
                    renderDayView();
                    break;
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'rewards':
                    renderRewards();
                    break;
                case 'quests':
                    renderQuests();
                    break;
                case 'settings':
                    renderSettings();
                    break;
            }
        }

        // ===== DAY VIEW =====
        function renderDayView() {
            const todaysTasks = getTodaysTasks();
            const tasksContainer = document.getElementById('tasks-container');
            
            if (todaysTasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✨</div>
                        <p>No tasks for today. Add a task to get started!</p>
                    </div>
                `;
            } else {
                tasksContainer.innerHTML = todaysTasks.map(task => renderTaskItem(task)).join('');
                setupDragAndDrop();
            }
        }

        function getTodaysTasks() {
            return appData.tasks
                .filter(task => {
                    // Exclude completed one-time tasks
                    if (task.recurrence === 'once' && task.completed) return false;
                    
                    // Reset completion counter for multiple-per-day tasks on new day
                    if (task.recurrence === 'multiple' && task.lastCompleted && !isToday(task.lastCompleted)) {
                        task.completionsToday = 0;
                    }
                    
                    // Exclude tasks completed today
                    if (task.recurrence === 'multiple') {
                        return task.completionsToday < task.timesPerDay;
                    } else {
                        return !task.lastCompleted || !isToday(task.lastCompleted);
                    }
                });
        }

        function isToday(dateString) {
            if (!dateString) return false;
            const date = new Date(dateString);
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function renderTaskItem(task) {
            const category = appData.categories.find(c => c.id === task.category);
            const categoryName = category ? category.name : 'Unknown';
            
            let streakText = '';
            if (task.recurrence === 'daily' && task.streak > 0) {
                streakText = `<span class="task-badge">🔥 ${task.streak}</span>`;
            }
            
            // For multiple per day tasks, show progress
            let recurrenceText = '';
            if (task.recurrence === 'daily') {
                recurrenceText = `<span class="task-badge">🔄</span>`;
            } else if (task.recurrence === 'multiple') {
                const completed = task.completionsToday || 0;
                const total = task.timesPerDay || 1;
                recurrenceText = `<span class="task-badge">🔄 ${completed}/${total}</span>`;
            }
            
            return `
                <div class="task-item" data-task-id="${task.id}">
                    <div class="task-drag-handle" draggable="true">⋮⋮</div>
                    <div class="task-content">
                        <div class="task-header">
                            <div class="task-actions">
                                ${recurrenceText}
                                <button class="btn-small btn-success" onclick="completeTask('${task.id}')">✓</button>
                            </div>
                            <div class="task-title">${task.title}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== DRAG AND DROP =====
        function setupDragAndDrop() {
            const dragHandles = document.querySelectorAll('.task-drag-handle[draggable="true"]');
            const taskItems = document.querySelectorAll('.task-item');
            
            dragHandles.forEach(handle => {
                // Desktop drag and drop
                handle.addEventListener('dragstart', handleDragStart);
                handle.addEventListener('dragend', handleDragEnd);
                
                // Mobile touch events
                handle.addEventListener('touchstart', handleTouchStart, { passive: false });
                handle.addEventListener('touchmove', handleTouchMove, { passive: false });
                handle.addEventListener('touchend', handleTouchEnd, { passive: false });
            });

            taskItems.forEach(item => {
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
            });
        }

        let draggedElement = null;
        let touchY = 0;
        let touchStartY = 0;

        function handleDragStart(e) {
            const taskItem = this.closest('.task-item');
            draggedElement = taskItem;
            taskItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            // Set the drag image to the entire task item
            e.dataTransfer.setDragImage(taskItem, e.offsetX, e.offsetY);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(e.currentTarget.parentElement, e.clientY);
            if (afterElement == null) {
                e.currentTarget.parentElement.appendChild(draggedElement);
            } else {
                e.currentTarget.parentElement.insertBefore(draggedElement, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            reorderTasks();
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            draggedElement = null;
        }

        // Touch event handlers for mobile
        function handleTouchStart(e) {
            draggedElement = this.parentElement; // Get the task-item parent
            touchStartY = e.touches[0].clientY;
            touchY = touchStartY;
            
            // Add dragging class after a short delay to distinguish from scroll
            setTimeout(() => {
                if (draggedElement) {
                    draggedElement.classList.add('dragging');
                }
            }, 200);
        }

        function handleTouchMove(e) {
            if (!draggedElement) return;
            
            e.preventDefault(); // Prevent scrolling while dragging
            touchY = e.touches[0].clientY;
            
            // Only start dragging if moved more than 10px
            if (Math.abs(touchY - touchStartY) < 10) return;
            
            draggedElement.classList.add('dragging');
            
            const container = draggedElement.parentElement;
            const afterElement = getDragAfterElement(container, touchY);
            
            if (afterElement == null) {
                container.appendChild(draggedElement);
            } else {
                container.insertBefore(draggedElement, afterElement);
            }
        }

        function handleTouchEnd(e) {
            if (!draggedElement) return;
            
            draggedElement.classList.remove('dragging');
            
            // Only reorder if actually dragged
            if (Math.abs(touchY - touchStartY) > 10) {
                reorderTasks();
            }
            
            draggedElement = null;
            touchY = 0;
            touchStartY = 0;
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function reorderTasks() {
            const taskElements = document.querySelectorAll('#tasks-container .task-item');
            const newOrder = Array.from(taskElements).map(el => el.dataset.taskId);
            
            // Get tasks shown in Today view vs all others
            const todaysTaskIds = new Set(getTodaysTasks().map(t => t.id));
            const tasksNotInToday = appData.tasks.filter(t => !todaysTaskIds.has(t.id));
            
            // Create ordered list from visible tasks
            const orderedTasks = newOrder
                .map(id => appData.tasks.find(t => t.id === id))
                .filter(t => t);
            
            // Update order property
            orderedTasks.forEach((task, index) => {
                task.order = index;
            });
            
            // Combine: ordered visible tasks + tasks not shown today
            appData.tasks = [...orderedTasks, ...tasksNotInToday];
            saveData();
        }

        // ===== TASK MANAGEMENT =====
        function openTaskModal(taskId = null, taskTitle = '') {
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('task-modal-title');
            
            // Populate categories
            const categorySelect = document.getElementById('task-category');
            categorySelect.innerHTML = appData.categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
            
            if (taskId) {
                // Edit mode
                const task = appData.tasks.find(t => t.id === taskId);
                title.textContent = 'Edit Task';
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-category').value = task.category;
                document.getElementById('task-recurrence').value = task.recurrence;
                document.getElementById('task-xp').value = task.xp;
                document.getElementById('task-coins').value = task.coins;
                document.getElementById('task-times-per-day').value = task.timesPerDay || 3;
            } else {
                // Add mode
                title.textContent = 'Add Task';
                document.getElementById('task-id').value = '';
                document.getElementById('task-title').value = taskTitle;
                document.getElementById('task-recurrence').value = 'once';
                document.getElementById('task-xp').value = appData.settings.defaultXp;
                document.getElementById('task-coins').value = appData.settings.defaultCoins;
                document.getElementById('task-times-per-day').value = 3;
            }
            
            handleRecurrenceChange();
            modal.classList.add('active');
        }

        function handleRecurrenceChange() {
            const recurrence = document.getElementById('task-recurrence').value;
            const container = document.getElementById('times-per-day-container');
            container.style.display = recurrence === 'multiple' ? 'block' : 'none';
        }

        function closeTaskModal() {
            document.getElementById('task-modal').classList.remove('active');
        }

        function saveTask() {
            const taskId = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value.trim();
            const category = document.getElementById('task-category').value;
            const recurrence = document.getElementById('task-recurrence').value;
            const xp = parseInt(document.getElementById('task-xp').value);
            const coins = parseInt(document.getElementById('task-coins').value);
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            
            if (taskId) {
                // Update existing task - preserve completion data
                const task = appData.tasks.find(t => t.id === taskId);
                task.title = title;
                task.category = category;
                task.recurrence = recurrence;
                task.xp = xp;
                task.coins = coins;
                
                // Update times per day for multiple recurrence
                if (recurrence === 'multiple') {
                    task.timesPerDay = parseInt(document.getElementById('task-times-per-day').value);
                    // Initialize completionsToday if it doesn't exist
                    if (!task.completionsToday) task.completionsToday = 0;
                }
                // Preserve: lastCompleted, streak, completed, completionsToday
            } else {
                // Create new task
                const taskData = {
                    id: 'task-' + Date.now(),
                    title,
                    category,
                    recurrence,
                    xp,
                    coins,
                    lastCompleted: null,
                    streak: 0,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    order: appData.tasks.length
                };
                
                // Add times per day for multiple recurrence
                if (recurrence === 'multiple') {
                    taskData.timesPerDay = parseInt(document.getElementById('task-times-per-day').value);
                    taskData.completionsToday = 0;
                }
                
                appData.tasks.push(taskData);
            }
            
            saveData();
            closeTaskModal();
            switchScreen(document.querySelector('.screen.active').id);
        }

        function editTask(taskId) {
            openTaskModal(taskId);
        }

        function reDoTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.lastCompleted = null;
            task.completed = false;
            
            saveData();
            switchScreen('day-view');
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                saveData();
                switchScreen(document.querySelector('.screen.active').id);
            }
        }

        function completeTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Handle multiple per day tasks
            if (task.recurrence === 'multiple') {
                if (!task.completionsToday) task.completionsToday = 0;
                
                // Reset if new day
                if (task.lastCompleted && !isToday(task.lastCompleted)) {
                    task.completionsToday = 0;
                }
                
                // Check if can complete more times today
                if (task.completionsToday >= task.timesPerDay) {
                    return;
                }
                
                task.completionsToday++;
                setTaskCompleted(task);
                
                // Update streak if all completions done for the day
                if (task.completionsToday >= task.timesPerDay) {
                    if (task.lastCompleted && isYesterday(task.lastCompleted)) {
                        task.streak++;
                    } else if (!task.streak) {
                        task.streak = 1;
                    }
                }
            } else {
                // Update streak for daily tasks
                if (task.recurrence === 'daily') {
                    if (task.lastCompleted && isYesterday(task.lastCompleted)) {
                        task.streak++;
                    } else if (!task.lastCompleted || !isToday(task.lastCompleted)) {
                        task.streak = 1;
                    }
                }
                
                // Mark as completed
                setTaskCompleted(task);
                if (task.recurrence === 'once') {
                    task.completed = true;
                }
            }
            
            // Award XP and coins
            appData.player.xp += task.xp;
            appData.player.coins += task.coins;
            
            // Update category XP
            const category = appData.categories.find(c => c.id === task.category);
            if (category) {
                category.xp += task.xp;
                updateCategoryLevel(category);
            }
            
            checkLevelUp();
            
            checkBadges();
            
            showToast(`+${task.xp} ⭐ +${task.coins} 🪙`);
            
            saveData();
            renderDayView();
        }
        
        function setTaskCompleted(task) {
            task.lastCompleted = new Date().toISOString();
            task.completedHistory = task.completedHistory || [];
            task.completedHistory.push(task.lastCompleted);
        }

        function isYesterday(dateString) {
            const date = new Date(dateString);
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return date.toDateString() === yesterday.toDateString();
        }

        // ===== LEVEL SYSTEM =====
        function getXpForLevel(level) {
            // XP needed increases by 50 each level
            return 100 + (level - 1) * 50;
        }

        function checkLevelUp() {
            let xpNeeded = getXpForLevel(appData.player.level);
            
            while (appData.player.xp >= xpNeeded) {
                appData.player.level++;
                xpNeeded = getXpForLevel(appData.player.level);
            }
        }

        function updateCategoryLevel(category) {
            const xpNeeded = getXpForLevel(category.level);
            if (category.xp >= xpNeeded) {
                category.level++;
                category.xp -= xpNeeded;
            }
        }

        // ===== BADGES SYSTEM =====
        function checkBadges() {
            const badges = [];
            
            // First task completed
            if (appData.tasks.some(t => t.completed || t.lastCompleted)) {
                addBadge('first-task', 'First Step', '✅', 'Complete your first task');
            }
            
            // Reach level 5
            if (appData.player.level >= 5) {
                addBadge('level-5', 'Rising Star', '⭐', 'Reach level 5');
            }
            
            // Reach level 10
            if (appData.player.level >= 10) {
                addBadge('level-10', 'Dedicated', '🌟', 'Reach level 10');
            }
            
            // 7 day streak
            if (appData.tasks.some(t => t.streak >= 7)) {
                addBadge('streak-7', 'Week Warrior', '🔥', 'Maintain a 7-day streak');
            }
            
            // 30 day streak
            if (appData.tasks.some(t => t.streak >= 30)) {
                addBadge('streak-30', 'Monthly Master', '🔥🔥', 'Maintain a 30-day streak');
            }
            
            // 100 coins earned
            if (appData.player.coins >= 100) {
                addBadge('coins-100', 'Penny Pincher', '🪙', 'Earn 100 coins');
            }
            
            // Category level 5
            appData.categories.forEach(cat => {
                if (cat.level >= 5) {
                    addBadge(`cat-${cat.id}-5`, `${cat.name} Expert`, '🏆', `Reach level 5 in ${cat.name}`);
                }
            });
        }

        function addBadge(id, name, icon, description) {
            if (!appData.badges.find(b => b.id === id)) {
                appData.badges.push({ id, name, icon, description, earnedAt: new Date().toISOString() });
                saveData();
            }
        }

        // ===== DASHBOARD =====
        function renderDashboard() {
            // Player stats
            document.getElementById('player-level').textContent = "⚔️ " + appData.player.level;
            document.getElementById('player-xp').textContent = "⭐ " + appData.player.xp;
            document.getElementById('player-coins').textContent = "🪙 " + appData.player.coins;
            
            // Level progress
            const currentLevelXp = appData.player.xp;
            const xpNeeded = getXpForLevel(appData.player.level);
            const xpForPrevLevel = appData.player.level > 1 ? getXpForLevel(appData.player.level - 1) : 0;
            const xpInCurrentLevel = currentLevelXp - xpForPrevLevel;
            const xpNeededForLevel = xpNeeded - xpForPrevLevel;
            const progress = Math.min((xpInCurrentLevel / xpNeededForLevel) * 100, 100);
            
            const levelProgress = document.getElementById('level-progress');
            levelProgress.style.width = progress + '%';
            
            const levelProgressText = document.getElementById('level-progress-text');
            levelProgressText.textContent = `${xpInCurrentLevel} / ${xpNeededForLevel} XP`;
            
            // Category progress
            const categoryContainer = document.getElementById('category-progress-container');
            categoryContainer.innerHTML = appData.categories.map(cat => {
                const xpNeeded = getXpForLevel(cat.level);
                const progress = (cat.xp / xpNeeded) * 100;
                return `
                    <div class="category-progress">
                        <div class="category-header">
                            <span>${cat.name} (Level ${cat.level})</span>
                            <span>${cat.xp} / ${xpNeeded} XP</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Streaks
            const streaksContainer = document.getElementById('streaks-container');
            const activeTasks = appData.tasks.filter(t => (t.recurrence === 'daily' || t.recurrence === 'multiple') && t.streak > 0);
            
            if (activeTasks.length === 0) {
                streaksContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No active streaks. Complete recurring tasks to build streaks!</p>
                    </div>
                `;
            } else {
                streaksContainer.innerHTML = activeTasks.map(task => {
                    const category = appData.categories.find(c => c.id === task.category);
                    return `
                        <div class="task-item">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta wp-40">
                                <span class="task-badge category-badge">${category.name}</span>
                                <span class="task-badge">🔥 ${task.streak}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Badges
            const badgesContainer = document.getElementById('badges-container');
            if (appData.badges.length === 0) {
                badgesContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No badges earned yet. Keep completing tasks!</p>
                    </div>
                `;
            } else {
                badgesContainer.innerHTML = appData.badges.map(badge => `
                    <div class="badge-item">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-desc">${badge.description}</div>
                    </div>
                `).join('');
            }
        }

        // ===== QUEST FILTER =====
        let questSearchTerm = '';

        function resetQuestFilter() {
            document.getElementById('quest-search').value = '';
            questSearchTerm = '';
        }

        function filterQuests() {
            questSearchTerm = document.getElementById('quest-search').value;
            renderQuests();
        }

        function renderQuests() {
            // Calculate stats
            const totalQuests = appData.tasks.length;
            
            // Filter tasks based on current filter and search
            let filteredTasks = [...appData.tasks];
            
            // Apply search
            if (questSearchTerm) {
                filteredTasks = filteredTasks.filter(task => {
                    const category = appData.categories.find(c => c.id === task.category);
                    const categoryName = category ? category.name.toLowerCase() : '';
                    return task.title.toLowerCase().includes(questSearchTerm.toLowerCase()) || 
                           categoryName.includes(questSearchTerm.toLowerCase()) ||
                           (task.lastCompleted && task.lastCompleted.includes(questSearchTerm)) ||
                           (task.completedHistory && task.completedHistory.some(date => date.includes(questSearchTerm)));
                });
            }
            
            // Render tasks
            const container = document.getElementById('quests-container');
            
            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <p>${questSearchTerm ? 'No tasks match your search.' : 'No tasks in this category.'}</p>
                        <button class="mt-20" onclick="openTaskModal(null, '${questSearchTerm}')">Add it?</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredTasks.map(task => {
                const category = appData.categories.find(c => c.id === task.category);
                const categoryName = category ? category.name : 'Unknown';
                
                let lastCompletedText = 'Never completed';
                
                if (task.lastCompleted) {
                    const date = new Date(task.lastCompleted);
                    const completedDates = [...new Set((task.completedHistory || [task.lastCompleted]).map(d => d.split('T')[0]).sort().reverse())].join(', ');
                    lastCompletedText = `Completions: ${completedDates}`;
                }
                
                let recurrenceInfo = '';
                if (task.recurrence === 'daily') {
                    recurrenceInfo = '<span class="task-badge">🔄</span>';
                } else if (task.recurrence === 'multiple') {
                    recurrenceInfo = `<span class="task-badge">🔄 ${task.timesPerDay}x</span>`;
                }
                
                let streakBadge = '';
                if (task.streak > 0) {
                    streakBadge = `<span class="task-badge">🔥 ${task.streak}</span>`;
                }
                
                const createdDate = new Date(task.createdAt).toLocaleDateString();
                
                return `
                    <div class="task-item">
                        <div class="task-content" style="width: 100%;">
                            <div class="task-header">
                                <div class="task-actions">
                                    ${task.completed ? '<button class="btn-small btn-secondary" onclick="reDoTask(\'' + task.id + '\')">↻</button>' : ''}
                                    <button class="btn-small btn-secondary" onclick="editTask('${task.id}')">✎</button>
                                    <button class="btn-small btn-danger" onclick="deleteTask('${task.id}')">×</button>
                                </div>
                                <div class="task-title">${task.title}</div>
                            </div>
                            <div class="task-meta">
                                <span class="task-badge category-badge">${categoryName}</span>
                                ${recurrenceInfo}
                                ${streakBadge}
                                <span class="task-badge">⭐ ${task.xp}</span>
                                <span class="task-badge">🪙 ${task.coins}</span>
                            </div>
                            <div class="base-strip" onclick="toggleStrip(this)">
                                <span style="color: var(--text-light); font-size: 13px; font-style: italic; ">${lastCompletedText}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleStrip(element) {
            element.style.height = element.style.height === 'auto' ? '30px' : 'auto';
        }

        // ===== REWARDS =====
        function renderRewards() {
            document.getElementById('rewards-coins').textContent = "🪙 " + appData.player.coins;
            
            const container = document.getElementById('rewards-container');
            if (appData.rewards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎁</div>
                        <p>No rewards yet. Add rewards you want to earn!</p>
                    </div>
                `;
            } else {
                container.innerHTML = appData.rewards.map(reward => {
                    const canAfford = appData.player.coins >= reward.cost;
                    const claimHistoryText = reward.claimHistory ? `Claims: ${reward.claimHistory.map(d => d.split('T')[0]).sort().reverse().join(', ')}`: 'Never claimed';
                    return `
                        <div class="reward-item">
                            <div style="float: right;">
                                <button class="btn-small ${canAfford ? 'btn-success' : 'btn-secondary'}" 
                                        onclick="claimReward('${reward.id}')" 
                                        ${!canAfford ? 'disabled' : ''}>
                                    Claim
                                </button>
                                <button class="btn-small btn-danger" onclick="deleteReward('${reward.id}')">×</button>
                            </div>
                            <div class="reward-info">
                                <span class="reward-name">${reward.name}</span>
                                <div class="task-badge">🪙 ${reward.cost}</div>
                                <div class="base-strip" onclick="toggleStrip(this)">
                                    <span style="color: var(--text-light); font-size: 13px; font-style: italic; ">${claimHistoryText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function openRewardModal() {
            const modal = document.getElementById('reward-modal');
            document.getElementById('reward-id').value = '';
            document.getElementById('reward-name').value = '';
            document.getElementById('reward-cost').value = '50';
            modal.classList.add('active');
        }

        function closeRewardModal() {
            document.getElementById('reward-modal').classList.remove('active');
        }

        function saveReward() {
            const name = document.getElementById('reward-name').value.trim();
            const cost = parseInt(document.getElementById('reward-cost').value);
            
            if (!name) {
                alert('Please enter a reward name');
                return;
            }
            
            appData.rewards.push({
                id: 'reward-' + Date.now(),
                name,
                cost,
                createdAt: new Date().toISOString()
            });
            
            saveData();
            closeRewardModal();
            renderRewards();
        }

        function deleteReward(rewardId) {
            if (confirm('Are you sure you want to delete this reward?')) {
                appData.rewards = appData.rewards.filter(r => r.id !== rewardId);
                saveData();
                renderRewards();
            }
        }

        function claimReward(rewardId) {
            const reward = appData.rewards.find(r => r.id === rewardId);
            if (!reward) return;
            
            if (appData.player.coins >= reward.cost) {
                if (confirm(`Claim "${reward.name}" for ${reward.cost} coins?`)) {
                    appData.player.coins -= reward.cost;
                    
                    reward.claimHistory = reward.claimHistory || [];
                    reward.claimHistory.push(new Date().toISOString());
                    
                    saveData();
                    renderRewards();
                }
            } else {
                alert('Not enough coins!');
            }
        }

        // ===== SETTINGS =====
        function renderSettings() {
            // Categories list
            const categoriesContainer = document.getElementById('categories-list');
            categoriesContainer.innerHTML = appData.categories.map(cat => `
                <div class="task-item">
                    <div class="task-content" style="width: 100%;">
                        <div class="flex-between">
                            <span class="task-title">${cat.name}</span>
                            <button class="btn-small btn-danger" onclick="deleteCategory('${cat.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Default values
            document.getElementById('default-xp').value = appData.settings.defaultXp;
            document.getElementById('default-coins').value = appData.settings.defaultCoins;
            
            // Theme toggle
            document.getElementById('theme-toggle').checked = appData.settings.darkTheme;
        }

        function openCategoryModal() {
            const modal = document.getElementById('category-modal');
            document.getElementById('category-name').value = '';
            modal.classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.remove('active');
        }

        function saveCategory() {
            const name = document.getElementById('category-name').value.trim();
            
            if (!name) {
                alert('Please enter a category name');
                return;
            }
            
            appData.categories.push({
                id: 'cat-' + Date.now(),
                name,
                xp: 0,
                level: 1
            });
            
            saveData();
            closeCategoryModal();
            renderSettings();
        }

        function deleteCategory(categoryId) {
            // Check if any tasks use this category
            const tasksUsingCategory = appData.tasks.filter(t => t.category === categoryId);
            
            if (tasksUsingCategory.length > 0) {
                alert('Cannot delete category that has tasks. Please delete or reassign the tasks first.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this category?')) {
                appData.categories = appData.categories.filter(c => c.id !== categoryId);
                saveData();
                renderSettings();
            }
        }

        function saveSettings() {
            appData.settings.defaultXp = parseInt(document.getElementById('default-xp').value);
            appData.settings.defaultCoins = parseInt(document.getElementById('default-coins').value);
            appData.settings.darkTheme = document.getElementById('theme-toggle').checked;
            saveData();
            applyTheme();
        }

        function applyTheme() {
            const isDark = appData.settings.darkTheme;
            const root = document.documentElement;
            
            // Update meta theme-color
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            
            if (isDark) {
                // Dark AMOLED Theme
                root.style.setProperty('--accent-color', '#666666');
                root.style.setProperty('--bg-color', '#000000');
                root.style.setProperty('--text-color', '#e0e0e0');
                root.style.setProperty('--text-light', '#999999');
                root.style.setProperty('--border-color', '#1a1a1a');
                root.style.setProperty('--hover-bg', '#1a1a1a');
                root.style.setProperty('--card-bg', '#0a0a0a');
                root.style.setProperty('--success-color', '#888888');
                root.style.setProperty('--danger-color', '#555555');
                root.style.setProperty('--shadow', '0 2px 8px rgba(255,255,255,0.05)');
                root.style.setProperty('--gradient-1', 'linear-gradient(90deg, #444444, #666666)');
                root.style.setProperty('--gradient-2', 'linear-gradient(90deg, #555555, #777777)');
                root.style.setProperty('--gradient-3', 'linear-gradient(90deg, #333333, #555555)');
                root.style.setProperty('--gradient-4', 'linear-gradient(90deg, #666666, #888888)');
                root.style.setProperty('--gradient-5', 'linear-gradient(90deg, #555555, #777777)');
                
                document.body.style.background = '#000000';
                document.body.style.backgroundAttachment = 'fixed';
                
                // Update meta theme color for dark theme
                if (metaThemeColor) {
                    metaThemeColor.setAttribute('content', '#000000');
                }
                
                // Apply dark theme class
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
            } else {
                // Bright Joyful Theme
                root.style.setProperty('--accent-color', '#FF6B9D');
                root.style.setProperty('--bg-color', '#FFF8E7');
                root.style.setProperty('--text-color', '#2D3436');
                root.style.setProperty('--text-light', '#636E72');
                root.style.setProperty('--border-color', '#FFD93D');
                root.style.setProperty('--hover-bg', '#FFF4C9');
                root.style.setProperty('--card-bg', '#FFFFFF');
                root.style.setProperty('--success-color', '#6BCF7F');
                root.style.setProperty('--danger-color', '#FF6B6B');
                root.style.setProperty('--shadow', '0 4px 12px rgba(255, 107, 157, 0.15)');
                root.style.setProperty('--gradient-1', 'linear-gradient(135deg, #667EEA 0%, #764BA2 100%)');
                root.style.setProperty('--gradient-2', 'linear-gradient(135deg, #F093FB 0%, #F5576C 100%)');
                root.style.setProperty('--gradient-3', 'linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%)');
                root.style.setProperty('--gradient-4', 'linear-gradient(135deg, #43E97B 0%, #38F9D7 100%)');
                root.style.setProperty('--gradient-5', 'linear-gradient(135deg, #FA709A 0%, #FEE140 100%)');
                
                document.body.style.background = 'linear-gradient(135deg, #FFF8E7 0%, #FFE5F1 50%, #E8F5FF 100%)';
                document.body.style.backgroundAttachment = 'fixed';
                
                // Update meta theme color for light theme
                if (metaThemeColor) {
                    metaThemeColor.setAttribute('content', '#FFF8E7');
                }
                
                // Apply light theme class
                document.body.classList.add('light-theme');
                document.body.classList.remove('dark-theme');
            }
            
            // Re-render current screen to update all elements
            switchScreen(document.querySelector('.screen.active').id);
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'qol-backup.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        appData = imported;
                        saveData();
                        location.reload();
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetData() {
            if (confirm('Are you sure you want to reset ALL data? This cannot be undone!')) {
                if (confirm('Really? This will delete everything!')) {
                    localStorage.removeItem('qolData');
                    location.reload();
                }
            }
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, duration = 3000) {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Hide and remove toast
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // ===== UTILITIES =====
        function toggleCollapsible(id) {
            const content = document.getElementById(id + '-content');
            const toggle = document.getElementById(id + '-toggle');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.textContent = '▼';
            } else {
                content.classList.add('open');
                toggle.textContent = '▲';
            }
        }


        // ===== SERVICE WORKER =====
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then((registration) => {
                    console.log('Service Worker registered successfully:', registration);
                }).catch((error) => {
                    console.log('Service Worker registration failed:', error);
                });
            }
        }

        history.pushState(null, null, location.href);
          window.onpopstate = function () {
          history.go(1); // lock in place
        };

        // ===== START APP =====
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
